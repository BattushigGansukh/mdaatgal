<!DOCTYPE html>
<html>
<head>
  <title>Submittal Form</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="form-container">
    <div class="logo-wrapper">
      <img src="MD Logo narrow.png" alt="Site Logo" class="site-logo">
    </div>
    <h2>
      <span class="icon"><img src="car.svg" alt="Form Icon"></span>
      Submittal Form
    </h2>

    <!-- Login Section -->
    <div id="login-section">
      <div class="form-group">
        <label for="login-email">
          <span class="icon"><img src="mail.svg" alt="Email"></span>
          Email:
        </label>
        <input type="email" id="login-email" name="login-email" placeholder="Email" required>
      </div>
      <div class="form-group">
        <label for="login-password">
          <span class="icon"><img src="password-check.svg" alt="Password"></span>
          Password:
        </label>
        <input type="password" id="login-password" name="login-password" placeholder="Password" required>
      </div>
      <button id="login-button" type="button">
        <span class="icon"><img src="log-in.svg" alt="Login"></span>
        Login
      </button>
    </div>

    <!-- Form Section -->
    <div id="form-section" style="display:none;">
      <form id="submittal-form">
        <div class="form-group">
          <label for="submittal_number">Submittal Number:</label>
          <input type="text" id="submittal_number" name="submittal_number" required>
        </div>
        <div class="form-group">
          <label for="revision">Revision:</label>
          <input type="number" id="revision" name="revision" required>
        </div>
        <div class="form-group">
          <label for="description">Description:</label>
          <textarea id="description" name="description" required></textarea>
        </div>
        <div class="form-group">
          <label for="attachment">Attachment:</label>
          <input type="text" id="attachment" name="attachment" placeholder="List of Attachments">
        </div>
        <div class="form-group">
          <label for="status">Status:</label>
          <select id="status" name="status">
            <option value="Under Review">Under Review</option>
            <option value="Approved">Approved</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div class="form-group">
          <label for="submittal_date">Submittal Date:</label>
          <input type="date" id="submittal_date" name="submittal_date">
        </div>
        <div class="form-group">
          <label for="review_due_date">Engineer Review Due Date:</label>
          <input type="date" id="review_due_date" name="review_due_date">
        </div>
        <div class="form-group">
          <label for="response_date">Response Date:</label>
          <input type="date" id="response_date" name="response_date">
        </div>
        <div class="form-group">
          <label for="photo_attachment">Photo Attachment:</label>
          <input type="file" id="photo_attachment" name="photo_attachment" accept="image/*,video/*">
        </div>
        <button type="submit">
          Submit
        </button>
      </form>
    </div>
  </div>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://ilbdpurxgzelsuimsfdo.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlsYmRwdXJ4Z3plbHN1aW1zZmRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4OTI4MDYsImV4cCI6MjA3NTQ2ODgwNn0.4y1Lbga8L1zjwxPHOANAj91n12afpNWqg3aEeM3ZsEU';

    const supabase = createClient(supabaseUrl, supabaseKey);

    // Allow pressing Enter in password field to trigger login
    document.getElementById('login-password').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('login-button').click();
      }
    });

    document.getElementById('login-button').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        alert('Login failed: ' + error.message);
      } else {
        alert('Login successful!');
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('form-section').style.display = 'block';
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('submittal-form');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submittal_number = document.getElementById('submittal_number').value;
        const revision = parseInt(document.getElementById('revision').value);
        const description = document.getElementById('description').value;
        const attachment = document.getElementById('attachment').value;
        const status = document.getElementById('status').value;
        const submittal_date = document.getElementById('submittal_date').value || null;
        const review_due_date = document.getElementById('review_due_date').value || null;
        const response_date = document.getElementById('response_date').value || null;

        const photoInput = document.getElementById('photo_attachment');
        const photoFile = photoInput.files[0];
        let photoUrl = null;

        if (photoFile) {
          const photoFileName = `${Date.now()}_${photoFile.name}`;
          const { data: uploadData, error: uploadError } = await supabase.storage
            .from('Photo attachment')
            .upload(photoFileName, photoFile);

          if (uploadError) {
            console.error('Upload error:', uploadError);
            alert('Photo upload failed: ' + uploadError.message);
            return;
          }

          const { data: publicUrlData } = supabase
            .storage
            .from('Photo attachment')
            .getPublicUrl(photoFileName);

          photoUrl = publicUrlData.publicUrl;
        }

        const { data, error } = await supabase
          .from('Submittal form')
          .insert([{
            'Submittal number': submittal_number,
            'Revision': revision,
            'Description': description,
            'Attachment': attachment,
            'Status': status,
            'Submittal Date': submittal_date,
            'Engineer Review Due Date': review_due_date,
            'Response Date': response_date,
            'Photo Attachment': photoUrl
          }]);

        if (error) {
          console.error('Insert error:', error);
          alert('Error: ' + error.message);
        } else {
          alert('Submitted successfully!');
          form.reset();
        }
      });
    });
  </script>
</body>
</html>